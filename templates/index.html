<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF 업로드</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      input[type="file"] {
        margin-bottom: 10px;
      }
      #progress {
        width: 100%;
        background-color: #f3f3f3;
        border: 1px solid #ccc;
        margin-top: 10px;
      }
      #progress-bar {
        height: 20px;
        width: 0;
        background-color: #4caf50;
      }
      #downloadBtn {
        margin-top: 20px;
        display: none; /* 초기에는 숨김 */
      }
    </style>
  </head>
  <body>
    <h1>PDF 파일 업로드</h1>
    <input type="file" id="fileInput" accept="application/pdf" />
    <button id="uploadBtn">업로드</button>
    <div id="progress">
      <div id="progress-bar"></div>
    </div>
    <div id="message"></div>
    <a id="downloadBtn" href="#" download>선형화된 파일 다운로드</a>

    <script>
      document.getElementById("uploadBtn").addEventListener("click", uploadFile);

      function uploadFile() {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (!file) {
          alert("파일을 선택하세요.");
          return;
        }

        const chunkSize = 1024 * 1024; // 1MB 청크 크기
        const totalChunks = Math.ceil(file.size / chunkSize);
        let currentChunk = 0;

        const progressBar = document.getElementById("progress-bar");
        const message = document.getElementById("message");
        const downloadBtn = document.getElementById("downloadBtn");
        progressBar.style.width = "0%";
        message.textContent = "";

        const uploadChunk = (chunk) => {
          const formData = new FormData();
          formData.append("file", chunk);
          formData.append("chunkNumber", currentChunk);
          formData.append("totalChunks", totalChunks);

          fetch("/pdf/upload", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("파일 업로드 실패");
              }
              currentChunk++;
              progressBar.style.width = `${((currentChunk / totalChunks) * 100).toFixed(2)}%`;
              message.textContent = `청크 ${currentChunk} / ${totalChunks} 업로드 완료`;

              if (currentChunk < totalChunks) {
                const nextChunk = file.slice(currentChunk * chunkSize, (currentChunk + 1) * chunkSize);
                uploadChunk(nextChunk);
              } else {
                message.textContent = "모든 청크가 업로드되었습니다.";
                downloadBtn.style.display = "inline"; // 다운로드 버튼을 표시
                downloadBtn.href = `/download/${file.name}`; // 다운로드 링크 설정
              }
            })
            .catch((error) => {
              message.textContent = error.message;
            });
        };

        const firstChunk = file.slice(0, chunkSize);
        uploadChunk(firstChunk);
      }
    </script>
  </body>
</html>
